name: Login Authentication Fix Verification

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'server/auth-simple.ts'
      - 'db/index.ts'
  push:
    branches: [ fix/login-authentication-bug ]

jobs:
  verify-fixes:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Verify crypto fix
      run: |
        echo "ğŸ” Verifying crypto module fix..."
        if grep -q "bcrypt.compare" server/auth-simple.ts; then
          echo "âœ… Crypto import fix verified"
        else
          echo "âŒ Crypto import fix missing"
          exit 1
        fi
        
    - name: Verify database check
      run: |
        echo "ğŸ” Verifying database connection check..."
        if grep -q "const decoded = jwt.verify" server/auth-simple.ts; then
          echo "âœ… Database connection check verified"
        else
          echo "âŒ Database connection check missing"
          exit 1
        fi
        
    - name: Verify health endpoint
      run: |
        echo "ğŸ” Verifying health check endpoint..."
        if grep -q "/api/auth-test" server/auth-simple.ts; then
          echo "âœ… Health check endpoint verified"
        else
          echo "âŒ Health check endpoint missing"
          exit 1
        fi
        
    - name: Verify error handling
      run: |
        echo "ğŸ” Verifying error handling..."
        if grep -q "console.error" server/auth-simple.ts; then
          echo "âœ… Error handling verified"
        else
          echo "âŒ Error handling missing"
          exit 1
        fi
        
    - name: Verify database logging
      run: |
        echo "ğŸ” Verifying database error logging..."
        if grep -q "console.error" db/index.ts; then
          echo "âœ… Database error logging verified"
        else
          echo "âŒ Database error logging missing"
          exit 1
        fi
        
    - name: Summary
      run: |
        echo "ğŸ‰ All login authentication fixes verified successfully!"
        echo "âœ… Crypto module fix"
        echo "âœ… Database connection check"
        echo "âœ… Health check endpoint"
        echo "âœ… Error handling"
        echo "âœ… Database error logging"
